<% use_gmaps_for(:project) %>

<div class="row">
    <div class="col-md-4">
        <div class="ibox float-e-margins">
            <div class="ibox-title">
                <%= audit_log_label(@project) %>
                <h5>Project details</h5>
            </div>
            <div class="ibox-content">
                <table class="table table-bordered table-striped">
                    <tbody>
                    <tr>
                        <th><%= Project.human_attribute_name('code') %></th>
                        <td><%= @project.code %></td>
                    </tr>
                    <tr>
                        <th><%= Project.human_attribute_name('name') %></th>
                        <td><%= @project.name %></td>
                    </tr>
                    <tr>
                        <th><%= Project.human_attribute_name('description') %></th>
                        <td><%= @project.description %></td>
                    </tr>
                    <tr>
                        <th><%= Project.human_attribute_name('address') %></th>
                        <td><%= @project.address %></td>
                    </tr>
                    <tr>
                        <th><%= Project.human_attribute_name('location') %></th>
                        <td><%= @project.location %></td>
                    </tr>
                    <tr>
                        <th><%= Project.human_attribute_name('country') %></th>
                        <td><%= @project.country %></td>
                    </tr>
                    <tr>
                      <th><%= Project.human_attribute_name('construction_year') %></th>
                      <td><%= @project.construction_year %></td>
                    </tr>
                    <tr>
                        <th><%= Project.human_attribute_name('gross_area') %></th>
                        <td><%= @project.gross_area %> m²</td>
                    </tr>
                    <tr>
                        <th><%= Project.human_attribute_name('certified_area') %></th>
                        <td><%= @project.certified_area %> m²</td>
                    </tr>
                    <tr>
                        <th><%= Project.human_attribute_name('carpark_area') %></th>
                        <td><%= @project.carpark_area %> m²</td>
                    </tr>
                    <tr>
                        <th><%= Project.human_attribute_name('project_site_area') %></th>
                        <td><%= @project.project_site_area %> m²</td>
                    </tr>
                    </tbody>
                </table>
                <input type="hidden" id="project_latlng" value="<%= @project.latlng %>" />
                <div id="project-map" class="map" style="height: 300px;"></div>
                <% if can? :update, @project %>
                    <div class="hr-line-dashed"></div>
                    <%= link_to raw('<i title="Edit project" class="fa fa-lg fa-edit" style="padding-right: 10px;"></i>Edit'), edit_project_path(@project), :class => 'btn btn-primary' %>
                <% end %>
            </div>
        </div>
    </div>
    <div class="col-md-8">
        <div class="ibox float-e-margins">
            <div class="ibox-title">
                <h5>Certificates</h5>
            </div>
            <div class="ibox-content">
                <% if @project.certification_paths.count.zero? %>
                    <p>This project hasn't applied for any certificate yet.</p>
                <% else %>
                    <table class="table table-bordered table-hover">
                        <thead>
                            <tr>
                                <th class="col-md-3">Stage</th>
                                <th class="col-md-2">Status</th>
                                <th class="col-md-1">Progress</th>
                                <th class="col-md-2">Certification goal</th>
                                <!--<th class="col-md-2">Current rating</th>-->
                            </tr>
                        </thead>
                        <tbody>
                        <% @project.certification_paths.each do |certification_path| %>
                            <tr class="clickable" data-href="<%= project_certification_path_path(@project, certification_path) %>">
                                <td><%= certification_path.name %></td>
                                <td><%= certification_path.status.humanize %></td>
                                <td>
                                <%
                                   if certification_path.requirement_data.count.nonzero?
                                     progress = certification_path.requirement_data.completed.count * 100 / certification_path.requirement_data.count
                                 %>
                                    <div class="progress">
                                        <div class="progress-bar" style="min-width: 2em; width: <%= progress %>%;"><%= progress %>%</div>
                                    </div>
                                <% else %>
                                    No progress yet
                                <% end %>
                                </td>
                                <td>
                                    <% if certification_path.registered? %>
                                        No goal set yet
                                    <% else %>
                                        <% targeted_score = certification_path.total_weighted_targeted_score %>
                                        <% stars = certification_path.star_rating_for_score(targeted_score) %>
                                        <%= stars %> Stars&nbsp;
                                        (<% stars.times do %>
                                            <i class="fa fa-star"></i>
                                        <% end %>) - <%= targeted_score %>
                                    <% end %>
                                </td>
                                <!-- submitted_score = certification_path.total_weighted_submitted_score %>
                                < stars = certification_path.star_rating_for_score(submitted_score) %>
                                <td>
                                    <= stars %> Stars&nbsp;
                                    (< stars.times do %>
                                        <i class="fa fa-star"></i>
                                    < end %>) - <= submitted_score %>
                                </td-->
                            </tr>
                        <% end %>
                        </tbody>
                    </table>
                <% end %>
                <!-- if can? :create, CertificationPath %-->
                <% if current_user.system_admin? || current_user.project_manager?(@project) %>
                    <div class="hr-line-dashed"></div>
                    <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#addCertificationPathModal"><i title="Apply for a certificate" class="fa fa-lg fa-certificate" style="padding-right: 10px;"></i>Apply for a certificate</button>
                <% end %>
            </div>
        </div>
        <div class="ibox float-e-margins">
            <div class="ibox-title">
                <h5>Project team</h5>
            </div>
            <div class="ibox-content">
                <% if @project.users.distinct.count.zero? %>
                <p>This project has no team members.</p>
                <% else %>
                <table class="table table-striped table-bordered table-hover datatable">
                    <thead>
                    <tr>
                        <th>Member</th>
                        <th>Role</th>
                        <th>Requirement progress</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr>
                        <td>Unassigned</td>
                        <td>-</td>
                        <td>
                          <%= RequirementDatum.for_project(@project).unassigned.completed.count %>/<%= RequirementDatum.for_project(@project).unassigned.count %>
                        </td>
                    </tr>
                    <% @project.users.distinct.each do |user| %>
                        <% project_authorization = user.project_authorizations.for_project(@project).first %>
                    <tr class="clickable" data-href="<%= project_user_tasks_path(@project, user) %>">
                        <td><%= user.email %></td>
                        <td><%= project_authorization.role.humanize %><% if @project.owner == user %>&nbsp;&amp;&nbsp;owner<% end %></td>
                        <td><% if !project_authorization.enterprise_account? %><%= user.requirement_data.for_project(@project).completed.count %>/<%= user.requirement_data.for_project(@project).count %><% else %>-<% end %></td>
                    </tr>
                    <% end %>
                    </tbody>
                </table>
                <% end %>
                <!-- if can? :create, ProjectAuthorization %-->
                <% if current_user.system_admin? || current_user.project_manager?(@project) %>
                <div class="hr-line-dashed"></div>
                <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#addProjectTeamMemberModal"><i title="Add project team member" class="fa fa-lg fa-user-plus" style="padding-right: 10px;"></i><%= t('.btn_add_project_team_member') %></button>
                <% end %>
            </div>
        </div>
        <div class="ibox float-e-margins">
            <div class="ibox-title">
                <h5>Certifier team</h5>
            </div>
            <div class="ibox-content">
                <% if @project.certifiers.distinct.count.zero? %>
                    <p>This project has no certifiers.</p>
                <% else %>
                    <table class="table table-striped table-bordered table-hover datatable">
                        <thead>
                        <tr>
                            <th>Member</th>
                            <th>Role</th>
                            <th>Criteria progress</th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr>
                            <td>Unassigned</td>
                            <td>-</td>
                            <td><%= SchemeMixCriterion.for_project(@project).unassigned.distinct.count %>/<%= SchemeMixCriterion.for_project(@project).distinct.count %></td>
                        </tr>
                        <% @project.certifiers.distinct.each do |certifier| %>
                            <tr class="clickable" data-href="<%= project_user_tasks_path(@project, certifier) %>">
                                <% project_authorization = certifier.project_authorizations.for_project(@project).first %>
                                <td><%= certifier.email %></td>
                                <td><%= project_authorization.role.humanize %></td>
                                <td>0/<%= certifier.scheme_mix_criteria.for_project(@project).count %></td>
                            </tr>
                        <% end %>
                        </tbody>
                    </table>
                <% end %>
                <!-- if can? :create, ProjectAuthorization %-->
                <% if current_user.system_admin? || current_user.certifier_manager?(@project) %>
                    <div class="hr-line-dashed"></div>
                    <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#addCertifierTeamMemberModal"><i title="Add certifier team member" class="fa fa-lg fa-user-plus" style="padding-right: 10px;"></i><%= t('.btn_add_certifier_team_member') %></button>
                <% end %>
            </div>
        </div>
    </div>
</div>
<%= render 'certification_paths/form' %>
<%= render 'project_authorizations/form', show_certifiers: true %>
<%= render 'project_authorizations/form', show_certifiers: false %>
<%= javascript_include_tag 'select_user' %>