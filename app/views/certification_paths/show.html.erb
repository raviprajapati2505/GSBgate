<div class="row">
    <div class="col-md-5">
        <div class="ibox float-e-margins">
            <div class="ibox-title">
                <%= audit_log_label(@certification_path) %>
                <h5>Certificate details</h5>
            </div>
            <div class="ibox-content">
                <table class="table table-bordered table-striped">
                    <tbody>
                    <tr>
                        <th>Certificate name</th>
                        <td><%= @certification_path.name %></td>
                    </tr>
                    <% if @certification_path.is_certified? %>
                        <tr>
                            <th>Downloads</th>
                            <td>
                                <% if can?(:download_certificate, @certification_path) %>
                                    <div>
                                        <%= link_to(download_certificate_report_project_certification_path_path(@project, @certification_path), { class: 'btn btn-xs btn-primary' }) do %>
                                            <%= fa_icon('download') %>
                                        <% end %>
                                        &nbsp;
                                        Download Certificate
                                    </div>
                                <% end %>
                                <% if can?(:download_certificate_coverletter, @certification_path) %>
                                    <div>
                                        <%= link_to(download_coverletter_report_project_certification_path_path(@project, @certification_path), { class: 'btn btn-xs btn-primary' }) do %>
                                            <%= fa_icon('download') %>
                                        <% end %>
                                        &nbsp;
                                        Download Coverletter
                                    </div>
                                <% end %>
                                <% if can?(:download_scores_report, @certification_path) %>
                                    <div>
                                        <%= link_to(download_scores_report_project_certification_path_path(@project, @certification_path), { class: 'btn btn-xs btn-primary' }) do %>
                                            <%= fa_icon('download') %>
                                        <% end %>
                                        &nbsp;
                                        Download Score Report
                                    </div>
                                <% end %>
                            </td>
                        </tr>
                    <% end %>
                    <% if not @certification_path.is_activating? %>
                        <tr>
                            <th>Started</th>
                            <td><%= @certification_path.started_at %></td>
                        </tr>
                    <% end %>
                    <% if @certification_path.certificate.letter_of_conformance? || @certification_path.certificate.final_design_certificate? %>
                        <tr>
                            <th>Duration</th>
                            <td><%= pluralize(@certification_path.duration, 'year') %></td>
                        </tr>
                    <% end %>
                    <tr>
                        <th>Rating</th>
                        <td><%= render 'certification_paths/star_ratings', certification_path: @certification_path %></td>
                    </tr>
                    <tr>
                        <th>Score</th>
                        <td>
                            <%= render 'score/score', scores: @certification_path.scores_in_certificate_points %>
                        </td>
                    </tr>
                    <tr>
                        <th>
                            PCR
                            <%= tooltip('Pre Certification Review. The project manager can apply for PCR. During PCR, GORD will assist the project team in completing the certification process.') %>
                        </th>
                        <td>
                            <div>
                                <%= fa_icon(@certification_path.pcr_track? ? 'check-square-o' : 'square-o') %>
                                <span>Applied for PCR</span>
                            </div>
                            <div>
                                <%= fa_icon(@certification_path.pcr_track_allowed? ? 'check-square-o' : 'square-o') %>
                                <span>PCR payment confirmed</span>
                            </div>
                        </td>
                    </tr>
                    <% if can?(:download_archive, @certification_path) %>
                        <tr>
                            <th>
                                Documents and audit logs
                                <%= tooltip('An archive of all approved documents and CSV formatted audit logs regarding the certificate can be downloaded here.') %>
                            </th>
                            <td>
                                <%= link_to(archive_project_certification_path_path, {class: 'btn btn-xs btn-primary', title: 'Creates a ZIP archive containing all approved documents in this certificate and related audit logs.'}) do %>
                                    <%= fa_icon('download') %>
                                <% end %>
                                &nbsp;
                                Download archive
                                <%= tooltip("This document archive contains #{@certification_path.scheme_mix_criteria_documents.approved.count} approved document(s).") %>
                            </td>
                        </tr>
                    <% end %>
                    </tbody>
                </table>
                <!-- apply is only allowed if the user has the ability, AND  there has nog yet been applied for pcr -->
                <% can_apply_for_pcr = can?(:apply_for_pcr, @certification_path) && !@certification_path.pcr_track? %>
                <!-- approve is only allowed if the user has the ability, AND an apply has been done, but it has not yet been approved -->
                <% can_approve_pcr = can?(:approve_pcr, @certification_path) && @certification_path.pcr_track? && !@certification_path.pcr_track_allowed? %>
                <% if can_apply_for_pcr || can_approve_pcr %>
                    <div class="hr-line-dashed"></div>
                <% end %>
                <% if @certification_path.certification_path_status_id < CertificationPathStatus::SUBMITTING_PCR %>
                    <% if can_apply_for_pcr %>
                        <%= link_to('Apply for PCR', apply_for_pcr_project_certification_path_path, { method: :put, class: 'btn btn-primary', data: { disable_with:'Applying...', confirm: 'You are now applying for the PCR track. This will require an extra fee. Please confirm your choice.'}}) %>
                    <% end %>
                    <% if can_approve_pcr %>
                        <%= link_to('Approve PCR application', approve_pcr_payment_project_certification_path_path, { method: :put, class: 'btn btn-primary', data: { disable_with:'Approving...', confirm: 'This will enable the PCR track for this certificate. Please confirm your choice.'}}) %>
                    <% end %>
                <% end %>
            </div>
        </div>

        <div class="ibox float-e-margins">
            <div class="ibox-title">
                <%= render 'timeline_legend' %>
                <h5>Certificate status</h5>
            </div>
            <div class="ibox-content">
                <%= render 'timeline', certification_path: @certification_path %>
                <% if can?(:update_status, @certification_path) %>
                    <% if @certification_path.certification_path_status_id == CertificationPathStatus::ACKNOWLEDGING %>
                        <div class="hr-line-dashed"></div>
                        <%= link_to(edit_status_project_certification_path_url(@project, @certification_path), {class: 'btn btn-primary', remote: true}) do %>
                            <%= fa_icon('check', 'Accept all scores') %>
                        <% end %>
                        <%= link_to(edit_status_project_certification_path_url(@project, @certification_path,  appeal: 1), {class: 'btn btn-primary', remote: true}) do %>
                            <%= fa_icon('hand-o-up', 'Apply for appeal') %>
                        <% end %>
                    <% else %>
                        <div class="hr-line-dashed"></div>
                        <%= link_to(edit_status_project_certification_path_url(@project, @certification_path), {class: 'btn btn-primary', remote: true}) do %>
                            <%= fa_icon('forward', "Advance status to '#{CertificationPathStatus.find_by(id: @certification_path.next_status).name}'") %>
                        <% end %>
                    <% end %>
                <% end %>
            </div>
        </div>
    </div>

    <div class="col-md-7">
        <div class="ibox float-e-margins">
            <div class="ibox-title">
                <h5>Schemes</h5>
            </div>
            <div class="ibox-content">
                <%= scores_legend %>
                <%= render 'scheme_mixes/overview', certification_path: @certification_path %>
                <% can_allocate_project_team_responsibility = @certification_path.in_submission? && can?(:allocate_project_team_responsibility, @certification_path) %>
                <% can_allocate_certifier_team_responsibility = @certification_path.in_verification? && can?(:allocate_certifier_team_responsibility, @certification_path) %>
                <% if can_allocate_project_team_responsibility || can_allocate_certifier_team_responsibility %>
                    <div class="hr-line-dashed"></div>
                    <% if can_allocate_project_team_responsibility %>
                        <button type="button" class="btn btn-white" data-toggle="modal" data-target="#allocateProjectTeamResponsibilityModal">
                            <%= fa_icon('th-list', 'Allocate project team responsibility') %>
                        </button>
                        <%= render 'allocate_project_team_responsibility', project: @project, certification_path: @certification_path %>
                    <% end %>
                    <% if can_allocate_certifier_team_responsibility %>
                        <button type="button" class="btn btn-white" data-toggle="modal" data-target="#allocateCertifierTeamResponsibilityModal">
                            <%= fa_icon('th-list', 'Allocate certifier team responsibility') %>
                        </button>
                        <%= render 'allocate_certifier_team_responsibility', project: @project, certification_path: @certification_path %>
                    <% end %>
                <% end %>
            </div>
        </div>
        <%= render 'tasks/tasks' %>
    </div>
</div>
<div id="editStatusCertificationPathModal" class="modal fade"></div>
<%= javascript_include_tag 'score_widget' %>
