<%
   raise('Project must be specified') if project.nil?
   raise('Team must be specified') if team.nil?
   case team
     when :project_team
       title = t('.project_team.title')
       title_modal = t('.project_team.title_modal')
       project_users = project.projects_users.project_team
       project_user_roles = ProjectsUser.roles.slice(:project_team_member, :cgp_project_manager)
       can_create_new_project_user = can?(:create, ProjectsUser.new(project_id: @project.id, role: ProjectsUser.roles[:project_team_member])) || can?(:create, ProjectsUser.new(project_id: @project.id, role: ProjectsUser.roles[:cgp_project_manager]))
       modal_id = 'addProjectTeamModal'
     when :gsas_trust_team
       title = t('.certifier_team.title')
       title_modal = t('.certifier_team.title_modal')
       project_users = project.projects_users.gsas_trust_team
       project_user_roles =  ProjectsUser.roles.slice(:certifier, :certification_manager)
       can_create_new_project_user = can?(:create, ProjectsUser.new(project_id: @project.id, role: ProjectsUser.roles[:certifier])) || can?(:create, ProjectsUser.new(project_id: @project.id, role: ProjectsUser.roles[:certification_manager]))
       gsas_trust_team_roles = [User.roles[:gsas_trust_admin], User.roles[:gsas_trust_manager], User.roles[:gsas_trust_top_manager]]
       modal_id = 'addGsasTrustTeamModal'
     when :enterprise_clients
       title = t('.enterprise_clients.title')
       title_modal = t('.enterprise_clients.title_modal')
       project_users = project.projects_users.enterprise_clients
       can_create_new_project_user = can?(:create, ProjectsUser.new(project_id: @project.id, role: ProjectsUser.roles[:enterprise_client]))
       project_user_roles =  ProjectsUser.roles.slice(:enterprise_client)
       modal_id = 'addEnterpriseClientModal'
   end
%>
<% if can?(:read, project_users[0]) %>
<div class="ibox float-e-margins">
    <div class="ibox-title">
        <h5><%= title %></h5>
    </div>
    <div class="ibox-content">
        <% if project_users.count.zero? %>
            <p>No users found.</p>
        <% else %>
            <table class="table table-striped table-bordered table-hover datatable" cellspacing="0" width="100%">
                <thead>
                <tr>
                    <th>Member name</th>
                    <th>Email</th>
                    <th>Role</th>
                    <% if team != :enterprise_clients %>
                        <th>Tasks</th>
                    <% end %>
                </tr>
                </thead>
                <tbody>
                <% if team == :gsas_trust_team %>
                    <% User.where(role: gsas_trust_team_roles).each do |admin_user| %>
                        <tr>
                            <td>
                                <% if admin_user == current_user %>
                                    <%= link_to tasks_path(project_id: project.id) do %>
                                        <%= admin_user.full_name %>
                                    <% end %>
                                <% else %>
                                    <%= admin_user.full_name %>
                                <% end %>
                            </td>
                            <td>
                                <%= admin_user.email %>
                            </td>
                            <td>
                                <%= t(admin_user.role, scope: 'activerecord.attributes.user.roles' ) %>
                            </td>
                            <td>
                                <span class="badge"><%= TaskService::count_tasks(user: admin_user, project_id: project.id) %></span>
                            </td>
                        </tr>
                    <% end %>
                <% end %>

                <% project_users.distinct.each do |projects_user| %>
                    <tr>
                        <td>
                            <%= can_link_to(project_user_path(project, projects_user), projects_user) do %>
                                <%= projects_user.user.full_name %>
                            <% end %>
                        </td>
                        <td>
                            <%= projects_user.user.email %>
                        </td>
                        <td>
                            <%= t(projects_user.role, scope: 'activerecord.attributes.projects_user.roles' ) %>
                        </td>
                        <% if team != :enterprise_clients %>
                            <td>
                                <span class="badge fa-lg"><%= TaskService::count_tasks(user: projects_user.user, project_id: project.id) %></span>
                            </td>
                        <% end %>
                    </tr>
                <% end %>
                </tbody>
            </table>
        <% end %>
        <% if can_create_new_project_user %>
            <div class="hr-line-dashed"></div>
            <%= btn_tag(icon: 'user-plus', text: title_modal, data: {toggle: 'modal', target: "##{modal_id}"}) %>
        <% end %>
    </div>
</div>

<div class="modal fade" id="<%= modal_id %>" aria-hidden="true" >
    <div class="modal-dialog">
        <%= bootstrap_form_for([project, @projects_user], as: :authorization, method: 'post', url: project_users_path(project, @projects_user)) do |f| %>
            <%= fields_for 'projects_users[]', ProjectsUser.new do |pu| %>
                <div class="modal-content">
                    <div class="modal-header">
                        <%= btn_close_modal %>
                        <h4 class="modal-title"><%= title_modal %></h4>
                    </div>
                    <div class="modal-body find-users-modal" data-project-id="<%= @project.id %>" data-gsas-trust-team="<%= (team == :gsas_trust_team) ? '1' : '0' %>">
                        <div class="templates" style="display:none;">
                            <script class="existing-user" type="text/x-custom-template">
                                <tr data-user-uid="____user_id____">
                                    <td>
                                        ____user_name____
                                        <%= pu.hidden_field :user_id, { value: '____user_id____' } %>
                                    </td>
                                    <td>
                                        This user will be added to the project as<br />
                                        <%= pu.select :role, project_user_roles.keys.map { |k| [t(k, scope: 'activerecord.attributes.projects_user.roles'), k] } %>
                                    </td>
                                    <td>
                                        <%= btn_tag(style: 'danger', size: 'small', icon: 'trash', class: 'remove', type: 'button') %>
                                    </td>
                                </tr>
                            </script>
                            <script class="unknown-user" type="text/x-custom-template">
                                <tr data-user-uid="____email____">
                                    <td>
                                        ____email____
                                        <%= hidden_field_tag 'emails[]', '____email____' %>
                                    </td>
                                    <td>
                                        This user will be invited to linkme.qa by email.
                                    </td>
                                    <td>
                                        <%= btn_tag(style: 'danger', size: 'small', icon: 'trash', class: 'remove', type: 'button') %>
                                    </td>
                                </tr>
                            </script>
                            <script class="error-user" type="text/x-custom-template">
                                <tr data-user-uid="____user_id____">
                                    <td>
                                        ____user_name____
                                    </td>
                                    <td>
                                        ____error____
                                    </td>
                                    <td>
                                        <%= btn_tag(style: 'danger', size: 'small', icon: 'trash', class: 'remove', type: 'button') %>
                                    </td>
                                </tr>
                            </script>
                        </div>
                        <p class="alert alert-info">
                            <%= fa_icon('info-circle') %> You can add one or more users to the project by entering their email addresses one by one.
                            Linkme.qa users can be added to the project immediately. Users without a linkme.qa account can be invited by email.
                        </p>
                        <div class="form-group">
                            <%= label_tag 'email' + team.to_s, 'Find users by email', class: 'control-label' %>
                            <div class="input-group">
                                <%= text_field_tag 'email' + team.to_s, '', class: 'email-field form-control' %>
                                <span class="input-group-btn">
                                    <%= btn_tag(class: 'find-users-by-email-btn', icon: 'search', style: 'white', type: 'button') %>
                                </span>
                            </div>
                            <p class="help-block"></p>
                        </div>
                        <table class="table table-striped table-bordered table-hover datatable users-table" style="display:none;">
                            <tbody>
                                <tr>
                                    <th>User</th>
                                    <th>Action</th>
                                    <th>&nbsp;</th>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="modal-footer">
                        <%= btn_save %>
                    </div>
                </div>
            <% end %>
        <% end %>
    </div>
</div>
<% end %>