<% if @prev_smc.present? %>
    <% @page_title_prefix = btn_link_to(project_certification_path_scheme_mix_scheme_mix_criterion_path(@certification_path.project, @certification_path, @scheme_mix, @prev_smc), icon: 'caret-left', icon_position: 'front', text: @prev_smc.code, style: 'white', size: 'small') %>
<% end %>
<% if @next_smc.present? %>
    <% @page_title_suffix = btn_link_to(project_certification_path_scheme_mix_scheme_mix_criterion_path(@certification_path.project, @certification_path, @scheme_mix, @next_smc), icon: 'caret-right', icon_position: 'back', text: @next_smc.code, style: 'white', size: 'small') %>
<% end %>
<div class="row">
<div class="col-lg-4">
    <div class="ibox criterion-details">
        <div class="ibox-title">
            <%= audit_log_label(@scheme_mix_criterion) %>
            <h5>Criterion details</h5>
        </div>
        <div class="ibox-content">
            <table class="table table-bordered table-striped">
                <tbody>
                <tr>
                    <th>Status</th>
                    <td>
                        <%= @scheme_mix_criterion.status.humanize %>
                    </td>
                </tr>
                </tbody>
            </table>
            <% if can?(:update_status, @scheme_mix_criterion) %>
                <div class="hr-line-dashed"></div>
                <% if @scheme_mix_criterion.at_certifier_side? %>
                    <% if @scheme_mix_criterion.in_verification? %>
                        <%= btn_link_to(edit_status_project_certification_path_scheme_mix_scheme_mix_criterion_path(@project, @certification_path, @scheme_mix, @scheme_mix_criterion, achieved: 1), remote: true, icon: 'check', text: 'Submitted score achieved') %>
                        <%= btn_link_to(edit_status_project_certification_path_scheme_mix_scheme_mix_criterion_path(@project, @certification_path, @scheme_mix, @scheme_mix_criterion, achieved: 0), remote: true, icon: 'times', text: 'Submitted score not achieved', style: 'danger') %>
                    <% else %>
                        <%= btn_link_to(edit_status_project_certification_path_scheme_mix_scheme_mix_criterion_path(@project, @certification_path, @scheme_mix, @scheme_mix_criterion, undo: 1), remote: true, icon: 'undo', text: 'Undo status change', style: 'danger') %>
                    <% end %>
                <% else %>
                    <% if @scheme_mix_criterion.in_submission? %>
                        <%= btn_link_to(edit_status_project_certification_path_scheme_mix_scheme_mix_criterion_path(@project, @certification_path, @scheme_mix, @scheme_mix_criterion), remote: true, icon: 'check', text: 'Submit criterion') %>
                    <% else %>
                        <%= btn_link_to(edit_status_project_certification_path_scheme_mix_scheme_mix_criterion_path(@project, @certification_path, @scheme_mix, @scheme_mix_criterion, undo: 1), remote: true, icon: 'undo', text: 'Undo status change', style: 'danger') %>
                    <% end %>
                <% end %>
            <% end %>
        </div>
    </div>
    <div class="ibox criterion-details">
        <div class="ibox-title">
            <h5>Criterion scores</h5>
        </div>
        <div class="ibox-content">
            <%= bootstrap_form_for([@project, @certification_path, @scheme_mix, @scheme_mix_criterion], url: update_scores_project_certification_path_scheme_mix_scheme_mix_criterion_path, method: 'put') do |f| %>
                <% if @scheme_mix_criterion.errors.any? %>
                    <div id="error_explanation">
                        <h2><%= pluralize(@scheme_mix_criterion.errors.count, "error") %> prohibited this criterion from being saved:</h2>
                        <ul>
                            <% @scheme_mix_criterion.errors.full_messages.each do |message| %>
                                <li><%= message %></li>
                            <% end %>
                        </ul>
                    </div>
                <% end %>
                <table class="table table-bordered table-striped">
                    <thead>
                    <tr>
                        <th></th>
                        <th>Score</th>
                    </tr>
                    </thead>
                    <% if @scheme_mix_criterion.scheme_criterion.minimum_score != @scheme_mix_criterion.scheme_criterion.minimum_valid_score %>
                        <p class="alert alert-warning"><%= fa_icon('info-circle') %>
                            The scores of this criterion should be at least <%= @scheme_mix_criterion.scheme_criterion.minimum_valid_score %> to be able to receive a certificate.
                        </p>
                    <% end %>
                    <tbody>
                    <tr>
                        <th>Targeted score <%= tooltip('The score the project team would like to achieve. Defaults to the maximum attainable score, but can be changed by a project manager.') %></th>
                        <td>
                            <% if can?(:update_targeted_score, @scheme_mix_criterion) %>
                                <%= f.select :targeted_score, @scheme_mix_criterion.scheme_criterion.scores, hide_label: true %>
                            <% else %>
                                <%= f.static_control :targeted_score, hide_label: true  %>
                            <% end %>
                        </td>
                    </tr>
                    <tr>
                        <th>Submitted score <%= tooltip('The score the project team will submit to GORD for verification. Will be provided by a project manager or a project team member that has been assigned to this criterion.') %></th>
                        <td>
                            <% if can?(:update_submitted_score, @scheme_mix_criterion) %>
                                <%= f.select :submitted_score, @scheme_mix_criterion.scheme_criterion.scores, {include_blank: '-', hide_label: true} %>
                            <% else %>
                                <%= f.static_control :submitted_score, hide_label: true %>
                            <% end %>
                        </td>
                    </tr>
                    <% if !@certification_path.in_pre_verification? %>
                    <tr>
                        <th>Achieved score <%= tooltip('The score GORD has awarded to this criterion. Will be provided by the certifier team and will be used for the final certification score.') %></th>
                        <td>
                            <% if can?(:update_achieved_score, @scheme_mix_criterion) %>
                                <%= f.select :achieved_score, @scheme_mix_criterion.scheme_criterion.scores, {include_blank: '-', hide_label: true} %>
                            <% else %>
                                <%= f.static_control :achieved_score, hide_label: true %>
                            <% end %>
                        </td>
                    </tr>
                    <% end %>
                    </tbody>
                </table>
                <% if can?(:update_targeted_score, @scheme_mix_criterion) || can?(:update_submitted_score, @scheme_mix_criterion) || can?(:update_achieved_score, @scheme_mix_criterion) %>
                    <div class="hr-line-dashed"></div>
                    <%= btn_save %>
                <% end %>
            <% end %>
        </div>
    </div>

    <div class="ibox">
        <div class="ibox-title">
            <h5>Certifier</h5>
        </div>
        <div class="ibox-content">
            <%= bootstrap_form_tag url: assign_certifier_project_certification_path_scheme_mix_scheme_mix_criterion_path(@project, @certification_path, @scheme_mix, @scheme_mix_criterion), method: 'put' do |f| %>
                <% if can?(:assign_certifier, @scheme_mix_criterion) %>
                    <div class="row">
                        <div class="col-md-7">
                            <% users = User.authorized_for_project(@project).with_certifier_project_role %>
                            <% user_id = @scheme_mix_criterion.certifier.id if @scheme_mix_criterion.certifier.present? %>
                            <%= f.select :user_id, options_for_select(users.map { |k| [k.email, k.id]}, user_id), {label: 'Responsibility', include_blank: ''}, class: 'select2-certifier' %>
                        </div>
                        <div class="col-md-5">
                            <%= f.text_field :due_date, value: ((l @scheme_mix_criterion.due_date, format: :short) if !@scheme_mix_criterion.due_date.nil?), prepend: '<i class="fa fa-calendar"></i>'.html_safe, class: 'datepicker-future', autocomplete: 'off' %>
                        </div>
                    </div>
                    <div class="hr-line-dashed"></div>
                    <%= btn_save %>
                <% else %>
                    <div class="row">
                        <div class="col-md-7">
                            <% if @scheme_mix_criterion.certifier.nil? %>
                                <%= f.label :user_id, 'Responsibility' %>
                                <p>This criterion is not yet assigned.</p>
                            <% else %>
                                <%= f.select :user_id, options_for_select([@scheme_mix_criterion.certifier].map { |k| [k.email, k.id]}, @scheme_mix_criterion.certifier.id), {label: 'Responsibility'}, disabled: true, class: 'select2-certifier' %>
                            <% end %>
                        </div>
                        <div class="col-md-5">
                            <%= f.text_field :due_date, value: ((l @scheme_mix_criterion.due_date, format: :short) if !@scheme_mix_criterion.due_date.nil?), prepend: '<i class="fa fa-calendar"></i>'.html_safe, class: 'datepicker-future', autocomplete: 'off', disabled: true %>
                        </div>
                    </div>
                <% end %>
            <% end %>
        </div>
    </div>

    <div class="ibox criterion-information">
        <div class="ibox-title">
            <h5>Criterion information</h5>
        </div>
        <div class="ibox-content">
            <% @scheme_mix_criterion.scheme_criterion.scheme_criterion_texts.each do |scheme_criterion_text| %>
                <div class="subtitle"><%= scheme_criterion_text.name.capitalize %></div>
                <div class="<%= scheme_criterion_text.name.downcase  %>"><%= scheme_criterion_text.html_text.html_safe %></div>
            <% end %>
        </div>
    </div>
</div>
<div class="col-lg-8">
    <% if @scheme_mix_criterion.requirement_data.assigned_to_user(current_user).present? %>
        <div class="ibox">
            <div class="ibox-title">
                <h5>Your requirements <%= tooltip('These requirements were assigned to you. It is your responsibility to provide documentation for these requirements.') %></h5>
            </div>
            <div class="ibox-content">
                <div class="row">
                    <div class="col-md-12">
                        <div id="accordion" class="panel-group">
                            <% @scheme_mix_criterion.requirement_data.assigned_to_user(current_user).each do |requirement_datum| %>
                                <%= render 'requirement_data/update', requirement_datum: requirement_datum %>
                            <% end %>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    <% end %>
    <% if @scheme_mix_criterion.requirement_data.not_assigned_to_user(current_user).present? %>
        <div class="ibox">
            <div class="ibox-title">
                <% if @scheme_mix_criterion.requirement_data.assigned_to_user(current_user).present? %>
                    <h5>Other requirements</h5>
                <% else %>
                    <h5>Requirements</h5>
                <% end %>
            </div>
            <div class="ibox-content">
                <div class="row">
                    <div class="col-md-12">
                        <div id="accordion" class="panel-group">
                            <% @scheme_mix_criterion.requirement_data.not_assigned_to_user(current_user).each do |requirement_datum| %>
                                <%= render 'requirement_data/update', requirement_datum: requirement_datum %>
                            <% end %>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    <% end %>
    <% if can?(:create, Document.new(:scheme_mix_criteria_documents_attributes => [{:scheme_mix_criterion_id => @scheme_mix_criterion.id}])) %>
        <div class="ibox">
            <div class="ibox-title">
                <h5>Upload documentation</h5>
            </div>
            <div class="ibox-content">
                <%= render 'documents/new', document: Document.new, project: @project, certification_path: @certification_path, scheme_mix: @scheme_mix,  scheme_mix_criterion_id: @scheme_mix_criterion.id %>
            </div>
        </div>
    <% end %>
    <div class="ibox" id="documentation">
        <div class="ibox-title">
            <h5>Documentation</h5>
        </div>
        <div class="ibox-content">
            <%= render 'scheme_mix_criteria_documents/index', scheme_mix_criteria_documents: @scheme_mix_criterion.scheme_mix_criteria_documents %>
        </div>
    </div>
</div>
</div>
<div id="editStatusSchemeMixCriterionModal" class="modal fade"></div>
<%= javascript_include_tag 'select_project_certifier' %>
<%= javascript_include_tag 'select_project_assessor' %>