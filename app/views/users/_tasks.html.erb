<div class="ibox float-e-margins">
    <div class="ibox-title">
        <h5>Project Tasks</h5>
    </div>
    <div class="ibox-content">
        <% assessor_task_count = user.requirement_data.for_project(@project).count %>
        <% certifier_task_count = user.scheme_mix_criteria.for_project(@project).count %>
        <% if assessor_task_count == 0 && certifier_task_count == 0 %>
            <p>No tasks are assigned to you.</p>
        <% else %>
            <table class="table table-bordered">
                <thead>
                <tr>
                    <th class="col-md-1">Code</th>
                    <th>Criteria</th>
                    <% if certifier_task_count > 0 %>
                        <th class="col-md-2">Due date</th>
                    <% end %>
                </tr>
                </thead>
                <tbody>
                <% SchemeMixCriterion.for_project(@project).assigned_to_user(user).order_by_code.group([:id, 'scheme_criteria.code']).each do |scheme_mix_criterion| %>
                    <tr class="clickable" data-href="<%= project_certification_path_scheme_mix_scheme_mix_criterion_path(@project, scheme_mix_criterion.scheme_mix.certification_path, scheme_mix_criterion.scheme_mix, scheme_mix_criterion) %>">
                        <td><%= scheme_mix_criterion.scheme_criterion.code %></td>
                        <td><%= scheme_mix_criterion.scheme_criterion.criterion.name %></td>
                        <% if certifier_task_count > 0 %>
                            <td><%= scheme_mix_criterion.due_date %><% if !scheme_mix_criterion.due_date.nil? && Date.today > scheme_mix_criterion.due_date %>&nbsp;<i class="fa fa-clock-o" title="<%= t('.tooltip_due_date') %>" data-toggle="tooltip"></i><% end %></td>
                        <% end %>
                    </tr>
                    <% if scheme_mix_criterion.requirement_data.assigned_to_user(user).exists? %>
                        <tr>
                            <td colspan="2">
                                <table class="table">
                                    <thead>
                                    <tr>
                                        <th class="col-md-1">Provided</th>
                                        <th class="col-md-9">Requirement</th>
                                        <th class="col-md-2">Due date</th>
                                    </tr>
                                    </thead>
                                    <tbody>
                                    <% scheme_mix_criterion.requirement_data.assigned_to_user(user).each do |requirement_datum| %>
                                        <tr>
                                            <td><% if requirement_datum.required? %><i class="fa fa-lg fa-square-o" title="<%= t('.tooltip_requirement_required') %>" data-toggle="tooltip"></i>
                                                <% elsif requirement_datum.provided? %><i class="fa fa-lg fa-check-square-o" title="<%= t('.tooltip_requirement_provided') %>" data-toggle="tooltip"></i>
                                                <% else %><i class="fa fa-lg fa-square" title="<%= t('.tooltip_requirement_not_required') %>" data-toggle="tooltip"></i><% end %>
                                            </td>
                                            <td><%= requirement_datum.requirement.label %></td>
                                            <td><%= requirement_datum.due_date %><% if requirement_datum.required? && !requirement_datum.due_date.nil? && Date.today > requirement_datum.due_date %>&nbsp;<i class="fa fa-clock-o" title="<%= t('.tooltip_due_date') %>" data-toggle="tooltip"></i><% end %></td>
                                        </tr>
                                    <% end %>
                                    </tbody>
                                </table>
                            </td>
                        </tr>
                    <% end %>
                <% end %>
                </tbody>
            </table>
        <% end %>
    </div>
</div>